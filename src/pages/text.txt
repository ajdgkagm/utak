import React, { useEffect, useRef, useState } from 'react'
import MainLayout from '../layouts/MainLayout'
import { toast } from 'react-toastify';
import { ComponentToPrint } from '../components/ComponentToPrint';
import { useReactToPrint } from 'react-to-print';
import { getDatabase, ref, set, push, get } from "firebase/database";
import app from '../firebaseConfig'
import 'firebase/compat/auth';
import 'firebase/compat/firestore';
import 'firebase/compat/database';
import 'firebase/compat/storage';
import { useNavigate } from 'react-router-dom';
function POSPage() {

    //   const [products, setProducts] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [cart, setCart] = useState([]);
    const [totalAmount, setTotalAmount] = useState(0);
    const [open, SetOpen] = useState(false);
    let [productArray, setProductArray] = useState([])
    const toastOptions = {
        autoClose: 400,
        pauseOnHover: true,
    }

    const navigate = useNavigate();

    const productss = productArray;




    useEffect(() => {
        const fetchData = async () => {
            const db = getDatabase(app);
            const dbRef = ref(db, "menu/category");
            const snapshot = await get(dbRef);
            if (snapshot.exists()) {

                const myData = snapshot.val();
                const temporaryArray = Object.keys(myData).map(myFireId => {
                    return {
                        ...myData[myFireId],
                        itemId: myFireId,
                    }
                })
                setProductArray(temporaryArray);
                console.log(temporaryArray, 'temporary array')
                console.log(myData)
            } else {
                console.log("No data")
            }
        }
        fetchData();
    }, [])
    const createData = async (state) => {
        const db = getDatabase(app);
        const newDocRef = push(ref(db, "menu/orders"));
        set(newDocRef, {
            // img: image,
            cart,
            totalAmount
        }).then(() => {
            // uploadImage()
            toast(`Added item to database`, toastOptions)
        }).catch((error) => {
            alert("error:", error.message)
        }
        )

    };

    const addProductToCart = async (product) => {
        // check if the adding product exist
        let findProductInCart = await cart.find(i => {
            return i.id === product.id
        });

        if (findProductInCart) {
            let newCart = [];
            let newItem;

            cart.forEach(cartItem => {
                if (cartItem.id === product.id) {
                    newItem = {
                        ...cartItem,
                        quantity: cartItem.quantity + 1,
                        totalAmount: cartItem.price * (cartItem.quantity + 1)
                    }
                    // console.log(newItem)
                    newCart.push(newItem);
                } else {
                    newCart.push(cartItem);
                }
            });

            setCart(newCart);
            toast(`Added ${newItem.name} to cart`, toastOptions)

        } else {
            let addingProduct = {
                ...product,
                'quantity': 1,
                'totalAmount': product.price,
            }
            setCart([...cart, addingProduct]);
            toast(`Added ${product.name} to cart`, toastOptions)
        }

    }
    
    const removeProduct = async (product) => {
        const newCart = cart.filter(cartItem => cartItem.id !== product.id);
        setCart(newCart);
    }

    const componentRef = useRef();

    const handleReactToPrint = useReactToPrint({
        content: () => componentRef.current,
    });

    const handlePrint = () => {
        handleReactToPrint();
    }

    useEffect(() => {
        // fetchProducts();
    }, []);

    useEffect(() => {
        let newTotalAmount = 0;
        cart.forEach(icart => {
            newTotalAmount = newTotalAmount + parseInt(icart.totalAmount);
        })
        setTotalAmount(newTotalAmount);
    }, [cart])


    console.log(cart)
    return (

        <MainLayout>
            {/* { productss.map(item =>{
    return (
        <ul>
            <li key={item.title}>{item.category}</li>
        </ul>
      );
  })} */}
            <div className='col-lg-12'>
                <div style={{ display: "none", position: 'absolute', left: 10, bottom: 200 }}>
                    <ComponentToPrint cart={cart} totalAmount={totalAmount} ref={componentRef} />
                </div>
                <div className='table-responsive bg-dark'>
                    <table className='table table-responsive table-dark table-hover'>
                        <thead>
                            <tr>
                                <td>#</td>
                                <td>Name</td>
                                <td>Price</td>
                                <td>Qty</td>
                                <td>Category</td>
                                <td>Option</td>
                                <td>Total</td>
                                <td>Action</td>
                            </tr>
                        </thead>
                        <tbody>
                            {cart ? cart.map((cartProduct, key) => <tr key={key}>

                                <td>{cartProduct.itemId}</td>
                                <td>{cartProduct.title}</td>
                                <td>{cartProduct.price}</td>
                                <td>{cartProduct.quantity}</td>
                                <td>{cartProduct.category}</td>
                                <td>{cartProduct.option === '' ? <select>
                                    <option>Small</option>
                                    <option>Medium</option>
                                    <option>Large</option>
                                </select> : null}</td>
                                <td>{cartProduct.totalAmount}</td>
                                <td>
                                    <button className='btn btn-danger btn-sm' onClick={() => removeProduct(cartProduct)}>Remove</button>
                                </td>

                            </tr>)

                                : 'No Item in Cart'}
                        </tbody>
                    </table>
                    <h2 className='px-2 text-white'>Total Amount: ${totalAmount} <input type="text" value="" /></h2>

                </div>

                <div className='mt-3'>
                    {totalAmount !== 0 ? <div>
                        <button className='btn btn-primary' onClick={createData}>
                            Pay Now
                        </button>


                    </div> : <div>

                        <button className='btn btn-primary' onClick={() => navigate(`/`)} >
                            Go Back
                        </button>
                    </div>


                    }
                </div>


            </div>

            <div className='row'>
                <div className='col-lg-12'>
                    {isLoading ? 'Loading' : <div className='row'>
                        {productss.map((product, key) =>
                            <div key={key} className='col-lg-4 mb-4'>
                                <div className='container' onClick={() => addProductToCart(product)}>
                                    <div className='flex-container'>
                                        <div className='flex-box' style={{backgroundColor: 'red'}}>
                                            <h6>{product.name}</h6>
                                            <p>{product.price}</p>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        )}
                    </div>}

                </div>

            </div>
            <div className="profile-container">



            </div>
        </MainLayout>
    )
}

export default POSPage